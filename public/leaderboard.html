<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    li { margin-bottom: 8px; }
    .loading { color: #666; }
    .error { color: #a00; }
    .meta { color: #666; font-size: 0.9em; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>Leaderboard</h2>
  <div id="status" class="loading">Loadingâ€¦</div>
  <div class="meta">Shows top users by points (read-only).</div>
  <div><small id="lastUpdated" class="meta"></small></div>

  <div style="margin:8px 0">
    <input id="testUser" placeholder="Test username" value="TestUser" style="padding:6px; font-size:14px" />
    <button id="btnTestAdd" style="padding:6px 10px; font-size:14px">Add test point</button>
    <span id="testStatus" style="margin-left:8px;color:#666"></span>
  </div>

  <ol id="list"></ol>

  <script>
    const POLL_MS = 5000;
    let pollTimer = null;

    function renderRows(data) {
      const list = document.getElementById('list');
      list.innerHTML = '';
      (data || []).forEach((e, idx) => {
        const li = document.createElement('li');
        const name = e.username || e.userId || 'Anonymous';
        li.textContent = `${idx + 1}. ${name} â€” ${e.points || 0} points`;
        list.appendChild(li);
      });
    }

    async function loadTop(limit = 50) {
      const status = document.getElementById('status');
      const last = document.getElementById('lastUpdated');
      try {
        status.textContent = 'Loadingâ€¦';
        status.className = '';
        // ðŸ‘‡ same-origin API; server.js exposes /api/leaderboard/top
        const res = await fetch('/api/leaderboard/top?limit=' + limit);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        renderRows(json.data || []);
        status.textContent = '';
        last.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        status.textContent = 'Failed to load leaderboard';
        status.className = 'error';
      }
    }

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      loadTop();
      pollTimer = setInterval(() => loadTop(), POLL_MS);
    }

    startPolling();
  </script>

  <script>
    // Test helper: POST a single point for the typed username
    document.getElementById('btnTestAdd').addEventListener('click', async function () {
      const user = document.getElementById('testUser').value.trim() || 'TestUser';
      const status = document.getElementById('testStatus');
      status.textContent = 'Sendingâ€¦';
      try {
        const res = await fetch('/api/leaderboard/increment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, delta: 1 })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        status.textContent = 'OK';
        setTimeout(() => status.textContent = '', 1200);
        // refresh list immediately
        loadTop();
      } catch (err) {
        console.error(err);
        status.textContent = 'Failed';
      }
    });
  </script>
</body>
</html>
